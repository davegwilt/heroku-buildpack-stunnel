#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# clean up leaking environment
unset GIT_DIR

# config
STUNNEL_VERSION="4.56"
STUNNEL_GITHUB_REPO="davegwilt/heroku-buildpack-python-libraries/numpy"

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

# import package_download
source $LP_DIR/support/package

echo "Using stunnel version: ${STUNNEL_VERSION}" | indent

# vendor directories
VENDORED_STUNNEL="vendor/stunnel"

# vendor stunnel into the slug
PATH="$BUILD_DIR/$VENDORED_STUNNEL/bin:$PATH"
echo "-----> Fetching and vendoring stunnel into slug"
mkdir -p "$BUILD_DIR/$VENDORED_STUNNEL/var/run/stunnel/"
package_download "stunnel" "${STUNNEL_VERSION}" "${STUNNEL_GITHUB_REPO}" "${BUILD_DIR}/${VENDORED_STUNNEL}"


echo "-----> Skipping the startup script"
echo "!      WARNING: This buildpack no longer generates a startup script."
echo "!               The stunnel binary will be available at /app/vendor/stunnel/bin/stunnel."
echo "!               Startup stunnel within your app using .profile or some other mechanism."
echo "-----> stunnel done"
